{% extends "_base.html" %}

{% block title %}AI Stock Analysis - Input{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* ... (All CSS styles from the previous version should remain here) ... */
    /*
      Assuming CSS custom properties like --primary, --secondary, --dark, --light,
      --success, --warning, --danger, --info, --font-main, and --primary-rgb
      are defined in your _base.html or a global style.css linked in _base.html.
      Example fallback values are provided.
    */

    .analyzer-page-body {
        background-color: var(--light, #f5f6fa);
        font-family: var(--font-main, 'Poppins', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif);
        color: var(--dark, #2d3436);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 2rem;
        padding-bottom: 2rem;
    }

    .analyzer-container {
        width: 100%;
        max-width: 650px;
        margin: 0 auto;
        padding: 1rem;
    }

    .analyzer-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        padding: 2.5rem;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .analyzer-card:hover {
        transform: translateY(-5px);
        /* Ensure --primary-rgb is defined, e.g., "16, 172, 132" for #10ac84 */
        box-shadow: 0 12px 35px rgba(var(--primary-rgb, 16, 172, 132), 0.15);
    }

    .analyzer-header {
        margin-bottom: 2rem;
    }

    .analyzer-header .icon {
        font-size: 3.5em;
        color: var(--primary, #10ac84);
        margin-bottom: 1rem;
        display: block;
    }

    .analyzer-header h1 {
        font-size: 2.2em;
        color: var(--dark, #2d3436);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .analyzer-header p {
        font-size: 1.1em;
        color: #555;
        line-height: 1.6;
    }

    .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 1em;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-sizing: border-box;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--primary, #10ac84);
        /* Ensure --primary-rgb is defined */
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb, 16, 172, 132), 0.25);
        outline: none;
    }

    .btn-analyze {
        background-color: var(--primary, #10ac84);
        color: white;
        padding: 0.875rem 1.5rem;
        font-size: 1.1em;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        display: inline-block;
        width: auto;
        min-width: 200px;
    }

    .btn-analyze:hover {
        background-color: #138d75; /* Darker shade of default --primary if not defined */
        transform: translateY(-2px);
    }
    .btn-analyze:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .flash-messages-container {
        width: 100%;
        max-width: 650px;
        margin: 0 auto 1.5rem auto;
        padding: 0 1rem;
        position: sticky;
        top: 10px;
        z-index: 1050;
    }

    .alert {
        border-radius: 8px;
        font-size: 1em;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .alert .btn-close {
        padding: 0.75rem 1rem;
        background-color: transparent;
        border: none;
        font-size: 1.2rem;
        opacity: 0.7;
    }
    .alert .btn-close:hover {
        opacity: 1;
    }

    /* --- Progress Indicator Styles --- */
    .progress-container-wrapper {
        display: none;
        width: 100%;
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        text-align: center;
    }

    .progress-container-wrapper h2 {
        font-size: 1.8em;
        color: var(--dark, #2d3436);
        margin-bottom: 0.5rem;
    }
    .progress-container-wrapper p {
        font-size: 1em;
        color: #555;
        margin-bottom: 1.5rem;
    }

    .progress-bar-custom {
        width: 100%;
        background-color: #e9ecef;
        border-radius: 25px;
        padding: 4px;
        margin-bottom: 1rem;
        height: 30px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .progress-bar-custom .progress-bar-inner {
        height: 100%;
        width: 0%;
        background-color: var(--success, #27ae60);
        background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
        background-size: 1rem 1rem;
        border-radius: 20px;
        transition: width 0.4s ease-in-out, background-color 0.4s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        font-size: 0.9em;
    }

    .progress-text {
        font-size: 1.1em;
        color: var(--dark, #2d3436);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .time-eta-container {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        color: #555;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    .time-display, .eta-display {
        background-color: var(--light, #f5f6fa);
        padding: 5px 10px;
        border-radius: 6px;
    }

    .progress-message-custom {
        font-size: 0.95em;
        color: #444;
        margin-top: 1rem;
        min-height: 20px;
    }

    #errorMessageArea {
        display: none;
        margin-top: 1.5rem;
        padding: 1rem;
        color: var(--danger-text, #721c24); /* Assumes --danger-text is defined, else dark red */
        background-color: var(--danger-bg, #f8d7da); /* Assumes --danger-bg is defined, else light red */
        border: 1px solid var(--danger, #e74c3c);
        border-radius: 8px;
        text-align: left;
    }
    /* --- End Progress Indicator Styles --- */

    @media (max-width: 768px) {
        .analyzer-card {
            padding: 2rem;
        }
        .analyzer-header h1 {
            font-size: 1.8em;
        }
        .analyzer-header p {
            font-size: 1em;
        }
        .progress-container-wrapper {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analyzer-page-body">
    <div class="flash-messages-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="analyzer-container" id="analyzerFormSection">
        <div class="analyzer-card">
            <div class="analyzer-header">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <h1>Stock Analyzer</h1>
                <p>Enter a stock ticker symbol to generate an in-depth AI-powered analysis and price prediction report.</p>
            </div>

            <form method="POST" action="{{ url_for('start_stock_analysis') }}" id="analyzeForm">
                <div class="form-group">
                    <label for="tickerInput">Stock Ticker Symbol</label>
                    <input type="text" class="form-control" id="tickerInput" name="ticker" placeholder="e.g., AAPL, MSFT, GOOGL" required>
                </div>
                <button type="submit" class="btn btn-analyze" id="analyzeButton">
                    <i class="fas fa-cogs"></i> Analyze Stock
                </button>
            </form>
        </div>
    </div>

    <div class="progress-container-wrapper" id="progressIndicator">
        <h2><i class="fas fa-hourglass-half"></i> Generating Your Report...</h2>
        <p>Please wait while we process your request. This may take a few moments.</p>
        <div class="progress-bar-custom">
            <div class="progress-bar-inner" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p class="progress-text" id="progressText">Initializing...</p>
        <div class="time-eta-container">
            <span class="time-display">Elapsed Time: <strong id="elapsedTime">0s</strong></span>
            <span class="eta-display">Est. Time Remaining: <strong id="etaTime">Calculating...</strong></span>
        </div>
        <p class="progress-message-custom" id="progressMessage">Fetching data and warming up the AI hamsters...</p>
        <div id="errorMessageArea" class="alert alert-danger" style="display: none; text-align:left;"></div>
         <p style="margin-top: 1.5rem; font-size: 0.85em; color: #777;">
            <i class="fas fa-info-circle"></i> Please do not close or refresh this page. You will be redirected automatically once the report is ready.
        </p>
    </div>
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const analyzeForm = document.getElementById('analyzeForm');
    const analyzerFormSection = document.getElementById('analyzerFormSection');
    const progressIndicator = document.getElementById('progressIndicator');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const elapsedTimeDisplay = document.getElementById('elapsedTime');
    const etaTimeDisplay = document.getElementById('etaTime');
    const progressMessage = document.getElementById('progressMessage');
    const errorMessageArea = document.getElementById('errorMessageArea');
    const tickerInput = document.getElementById('tickerInput');
    const analyzeButton = document.getElementById('analyzeButton');

    let timerInterval;
    let elapsedTime = 0;
    let progressSimulationInterval;
    let currentProgress = 0;
    let estimatedTotalTime = 20; // Default, will be recalculated

    const progressStages = [
        { percent: 10, message: "Connecting to data streams...", duration: 1 },     // Approx 1 sec
        { percent: 25, message: "Fetching historical stock data...", duration: 1 },  // Approx 2 sec
        { percent: 40, message: "Analyzing market trends...", duration: 1 },       // Approx 2 sec
        { percent: 60, message: "Running predictive models...", duration: 1 },      // Approx 3 sec
        { percent: 75, message: "Compiling fundamental analysis...", duration: 1 }, // Approx 2 sec
        { percent: 90, message: "Generating report visuals...", duration: 1 },     // Approx 2 sec
        { percent: 95, message: "Finalizing report structure...", duration: 1 },   // Approx 2 sec
        { percent: 100, message: "Almost ready!", duration: 0 }                     // Instant completion
    ];
    estimatedTotalTime = progressStages.reduce((acc, stage) => acc + stage.duration, 0);

    function startTimer() {
        elapsedTime = 0;
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        elapsedTime++;
        elapsedTimeDisplay.textContent = `${elapsedTime}s`;
        updateETA();
    }

    function stopTimer() {
        clearInterval(timerInterval);
        if (progressSimulationInterval) clearTimeout(progressSimulationInterval);
    }

    function updateETA() {
        const timeRemaining = Math.max(0, estimatedTotalTime - elapsedTime);
        if (currentProgress < 95 && elapsedTime <= estimatedTotalTime) { // Show ETA normally
             etaTimeDisplay.textContent = `${timeRemaining}s`;
        } else if (currentProgress >= 95 && currentProgress < 100) { // Nearing end of simulation
            etaTimeDisplay.textContent = `Finalizing...`;
        } else if (elapsedTime > estimatedTotalTime && currentProgress < 100) { // If simulation is slower than expected but not complete
            etaTimeDisplay.textContent = `Just a bit more...`;
        } else { // Simulation complete or past estimated time
            etaTimeDisplay.textContent = `Done!`;
        }
    }
    
    function resetProgress() {
        stopTimer();
        currentProgress = 0;
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.style.backgroundColor = 'var(--success, #27ae60)';
        }
        if (progressText) progressText.textContent = 'Initializing...';
        if (elapsedTimeDisplay) elapsedTimeDisplay.textContent = '0s';
        if (etaTimeDisplay) etaTimeDisplay.textContent = 'Calculating...';
        if (progressMessage) progressMessage.textContent = 'Ready to start.';
        if (analyzerFormSection) analyzerFormSection.style.display = 'block';
        if (progressIndicator) progressIndicator.style.display = 'none';
        if (errorMessageArea) errorMessageArea.style.display = 'none';
        
        if (tickerInput) tickerInput.disabled = false;
        if (analyzeButton) analyzeButton.disabled = false;
    }

    function simulateProgress() {
        currentProgress = 0;
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.style.backgroundColor = 'var(--success, #27ae60)';
        }

        let stageIndex = 0;

        function runStage() {
            if (stageIndex >= progressStages.length || (currentProgress >= 100 && stageIndex > 0) ) {
                currentProgress = 100; // Ensure it hits 100%
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                }
                if (progressText) progressText.textContent = 'Processing Complete!';
                if (progressMessage) progressMessage.textContent = 'Waiting for server to redirect...';
                if (etaTimeDisplay) etaTimeDisplay.textContent = 'Done!';
                // Actual redirect is handled by the server response to the form POST
                return;
            }

            const stage = progressStages[stageIndex];
            currentProgress = stage.percent;
            
            if (progressBar) {
                progressBar.style.width = `${currentProgress}%`;
                progressBar.textContent = `${currentProgress}%`;
            }
            if (progressText) progressText.textContent = `Progress: ${currentProgress}%`;
            if (progressMessage) progressMessage.textContent = stage.message;
            
            if (stage.duration > 0 && currentProgress < 100) {
                progressSimulationInterval = setTimeout(() => {
                    stageIndex++;
                    runStage();
                }, stage.duration * 1000);
            } else { 
                stageIndex++;
                runStage(); // Move to next stage if duration is 0 or already 100%
            }
        }
        runStage();
    }

    if (analyzeForm) {
        analyzeForm.addEventListener('submit', function (event) {
            // Client-side validation
            if (!tickerInput.value.trim()) {
                event.preventDefault(); 
                const tempErrorMsg = document.createElement('p');
                tempErrorMsg.textContent = 'Ticker symbol is required.';
                tempErrorMsg.style.color = 'var(--danger, #e74c3c)';
                tempErrorMsg.style.fontSize = '0.9em';
                tempErrorMsg.style.textAlign = 'left';
                tempErrorMsg.style.marginTop = '5px';
                const existingError = analyzeForm.querySelector('.temp-input-error');
                if (existingError) existingError.remove();
                tempErrorMsg.classList.add('temp-input-error');
                tickerInput.parentNode.appendChild(tempErrorMsg);
                setTimeout(() => tempErrorMsg.remove(), 3000);
                return;
            }
            const existingError = analyzeForm.querySelector('.temp-input-error');
            if (existingError) existingError.remove();

            // Do NOT disable tickerInput, only the button
            if (analyzeButton) analyzeButton.disabled = true;
            
            if (analyzerFormSection) analyzerFormSection.style.display = 'none';
            
            const flashMessages = document.querySelector('.flash-messages-container');
            if (flashMessages) flashMessages.innerHTML = ''; 

            if (errorMessageArea) errorMessageArea.style.display = 'none'; 
            
            if (progressIndicator) {
                progressIndicator.style.display = 'block';
                progressIndicator.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            startTimer();
            simulateProgress();
            // Standard form submission will proceed. Server will handle redirect.
        });
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted && progressIndicator && progressIndicator.style.display === 'block') {
            resetProgress();
        }
        if (tickerInput && tickerInput.disabled) {
            tickerInput.disabled = false;
        }
        if (analyzeButton && analyzeButton.disabled) {
             analyzeButton.disabled = false;
        }
    });

    const allAlerts = document.querySelectorAll('.flash-messages-container .alert');
    allAlerts.forEach(function(alert) {
        if (!alert.classList.contains('alert-danger')) {
            setTimeout(function() {
                if (typeof bootstrap !== 'undefined' && bootstrap.Alert && bootstrap.Alert.getInstance(alert)) {
                    bootstrap.Alert.getInstance(alert).close();
                } else {
                    alert.style.transition = 'opacity 0.5s ease-out';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 500);
                }
            }, 7000);
        }
    });
});
</script>
{% endblock %}