{% extends "_base.html" %}

{% block title %}Admin - Quota Management | Tickzen{% endblock %}

{% block head_extra %}
<meta name="robots" content="noindex, nofollow">
<style>
.admin-container {
    max-width: 1400px;
    margin: 40px auto;
    padding: 0 20px;
}

.admin-header {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    padding: 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.admin-header h1 {
    margin: 0 0 10px 0;
    font-size: 32px;
    font-weight: 700;
}

.admin-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 16px;
}

.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.stat-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
}

.stat-icon.success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
}

.stat-icon.warning {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    color: white;
}

.stat-icon.danger {
    background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
    color: white;
}

.stat-card-content h3 {
    margin: 0;
    font-size: 14px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card-content .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1e293b;
    margin-top: 4px;
}

.filters-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.filters-row {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    font-weight: 600;
    color: #475569;
}

.filter-group input,
.filter-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.users-table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table thead {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.users-table th {
    padding: 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e2e8f0;
}

.users-table td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
    color: #334155;
}

.users-table tbody tr {
    transition: background-color 0.2s ease;
}

.users-table tbody tr:hover {
    background-color: #f8fafc;
}

.plan-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.plan-badge.free {
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    color: white;
}

.plan-badge.pro {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
}

.plan-badge.pro-plus {
    background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    color: white;
}

.plan-badge.enterprise {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    color: white;
}

.usage-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.usage-bar {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    min-width: 80px;
}

.usage-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.usage-fill.warning {
    background: linear-gradient(90deg, #FF9800 0%, #F57C00 100%);
}

.usage-fill.danger {
    background: linear-gradient(90deg, #F44336 0%, #D32F2F 100%);
}

.usage-text {
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    min-width: 60px;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-primary {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
}

.btn-success:hover {
    background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    transform: translateY(-2px);
}

.btn-warning {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #F57C00 0%, #E64A19 100%);
    transform: translateY(-2px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2196F3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    font-size: 20px;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-header h2 {
    margin: 0;
    font-size: 24px;
    color: #1e293b;
}

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #94a3b8;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: #f1f5f9;
    color: #475569;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #475569;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.form-group small {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #64748b;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

.btn-cancel {
    background: #e2e8f0;
    color: #475569;
}

.btn-cancel:hover {
    background: #cbd5e1;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> Admin - Quota Management</h1>
        <p>Monitor and manage user quotas, upgrade plans, and track overall usage</p>
    </div>

    <!-- Statistics -->
    <div class="admin-stats">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Total Users</h3>
                    <div class="stat-value" id="stat-total-users">-</div>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon success">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Total Reports</h3>
                    <div class="stat-value" id="stat-total-reports">-</div>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon warning">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Premium Users</h3>
                    <div class="stat-value" id="stat-premium-users">-</div>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Quota Exceeded</h3>
                    <div class="stat-value" id="stat-exceeded-users">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label for="filter-search">Search User</label>
                <input type="text" id="filter-search" placeholder="Email or name...">
            </div>
            <div class="filter-group">
                <label for="filter-plan">Plan</label>
                <select id="filter-plan">
                    <option value="">All Plans</option>
                    <option value="Free">Free</option>
                    <option value="Pro">Pro</option>
                    <option value="Pro+">Pro+</option>
                    <option value="Enterprise">Enterprise</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-status">Status</label>
                <select id="filter-status">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="warning">Near Limit (80%+)</option>
                    <option value="exceeded">Quota Exceeded</option>
                </select>
            </div>
            <div class="filter-group" style="display: flex; align-items: flex-end;">
                <button class="btn btn-primary" onclick="refreshUsersTable()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Plan</th>
                    <th>Usage</th>
                    <th>Last Reset</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading users...</h3>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="edit-user-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit User Quota</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="edit-user-form" onsubmit="saveUserQuota(event)">
            <input type="hidden" id="edit-user-id">
            
            <div class="form-group">
                <label>User Email</label>
                <input type="text" id="edit-user-email" disabled>
            </div>
            
            <div class="form-group">
                <label for="edit-plan-name">Plan</label>
                <select id="edit-plan-name" required onchange="updateQuotaLimits()">
                    <option value="Free">Free</option>
                    <option value="Pro">Pro</option>
                    <option value="Pro+">Pro+</option>
                    <option value="Enterprise">Enterprise</option>
                </select>
                <small>Select a plan to auto-fill limits</small>
            </div>
            
            <div class="form-group">
                <label for="edit-stock-limit">Stock Reports Limit</label>
                <input type="number" id="edit-stock-limit" min="0" required>
                <small>Set to 999999 for unlimited</small>
            </div>
            
            <div class="form-group">
                <label for="edit-used-reports">Used Reports (Current)</label>
                <input type="number" id="edit-used-reports" min="0" required>
                <small>Current usage count</small>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-reset-quota" style="width: auto; margin-right: 8px;">
                    Reset usage to 0
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<script>
let allUsers = [];
let filteredUsers = [];

// Load users on page load
document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    setupFilters();
});

async function loadUsers() {
    showLoading();
    try {
        const response = await fetch('/admin/api/quota/users');
        if (!response.ok) throw new Error('Failed to load users');
        
        const data = await response.json();
        allUsers = data.users || [];
        filteredUsers = [...allUsers];
        
        updateStatistics(data.statistics);
        renderUsersTable();
    } catch (error) {
        console.error('Error loading users:', error);
        showError('Failed to load users. Please refresh the page.');
    } finally {
        hideLoading();
    }
}

function updateStatistics(stats) {
    document.getElementById('stat-total-users').textContent = stats.total_users || 0;
    document.getElementById('stat-total-reports').textContent = stats.total_reports_used || 0;
    document.getElementById('stat-premium-users').textContent = stats.premium_users || 0;
    document.getElementById('stat-exceeded-users').textContent = stats.exceeded_users || 0;
}

function renderUsersTable() {
    const tbody = document.getElementById('users-table-body');
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <h3>No users found</h3>
                    <p>Try adjusting your filters</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredUsers.map(user => {
        const used = user.stock_reports_used || 0;
        const limit = user.stock_reports_limit || 0;
        const unlimited = user.stock_reports_unlimited;
        const percentage = unlimited ? 0 : (limit > 0 ? Math.round((used / limit) * 100) : 0);
        
        let usageClass = '';
        if (percentage >= 100) usageClass = 'danger';
        else if (percentage >= 80) usageClass = 'warning';
        
        const displayLimit = unlimited ? 'âˆž' : limit;
        const lastReset = user.last_reset_at ? new Date(user.last_reset_at).toLocaleDateString() : 'Never';
        
        return `
            <tr data-user-id="${user.user_id}">
                <td><strong>${user.display_name || 'N/A'}</strong></td>
                <td>${user.email}</td>
                <td><span class="plan-badge ${user.plan_name.toLowerCase().replace(/\+/g, '-plus')}">${user.plan_name}</span></td>
                <td>
                    <div class="usage-indicator">
                        <div class="usage-bar">
                            <div class="usage-fill ${usageClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <span class="usage-text">${used}/${displayLimit}</span>
                    </div>
                </td>
                <td>${lastReset}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="openEditModal('${user.user_id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="resetUserQuota('${user.user_id}')">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function setupFilters() {
    const searchInput = document.getElementById('filter-search');
    const planSelect = document.getElementById('filter-plan');
    const statusSelect = document.getElementById('filter-status');
    
    [searchInput, planSelect, statusSelect].forEach(el => {
        el.addEventListener('input', applyFilters);
    });
}

function applyFilters() {
    const search = document.getElementById('filter-search').value.toLowerCase();
    const plan = document.getElementById('filter-plan').value;
    const status = document.getElementById('filter-status').value;
    
    filteredUsers = allUsers.filter(user => {
        // Search filter
        const matchesSearch = !search || 
            user.email.toLowerCase().includes(search) ||
            (user.display_name && user.display_name.toLowerCase().includes(search));
        
        // Plan filter
        const matchesPlan = !plan || user.plan_name === plan;
        
        // Status filter
        let matchesStatus = true;
        if (status) {
            const used = user.stock_reports_used || 0;
            const limit = user.stock_reports_limit || 0;
            const percentage = limit > 0 ? (used / limit) * 100 : 0;
            
            if (status === 'exceeded') matchesStatus = percentage >= 100;
            else if (status === 'warning') matchesStatus = percentage >= 80 && percentage < 100;
            else if (status === 'active') matchesStatus = percentage < 80;
        }
        
        return matchesSearch && matchesPlan && matchesStatus;
    });
    
    renderUsersTable();
}

function refreshUsersTable() {
    loadUsers();
}

function openEditModal(userId) {
    const user = allUsers.find(u => u.user_id === userId);
    if (!user) return;
    
    document.getElementById('edit-user-id').value = user.user_id;
    document.getElementById('edit-user-email').value = user.email;
    document.getElementById('edit-plan-name').value = user.plan_name;
    document.getElementById('edit-stock-limit').value = user.stock_reports_limit || 0;
    document.getElementById('edit-used-reports').value = user.stock_reports_used || 0;
    document.getElementById('edit-reset-quota').checked = false;
    
    document.getElementById('edit-user-modal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('edit-user-modal').classList.remove('active');
}

function updateQuotaLimits() {
    const plan = document.getElementById('edit-plan-name').value;
    const limits = {
        'Free': 10,
        'Pro': 50,
        'Pro+': 150,
        'Enterprise': 999999
    };
    
    document.getElementById('edit-stock-limit').value = limits[plan] || 10;
}

async function saveUserQuota(event) {
    event.preventDefault();
    
    const userId = document.getElementById('edit-user-id').value;
    const planName = document.getElementById('edit-plan-name').value;
    const stockLimit = parseInt(document.getElementById('edit-stock-limit').value);
    const usedReports = document.getElementById('edit-reset-quota').checked ? 0 : parseInt(document.getElementById('edit-used-reports').value);
    
    showLoading();
    try {
        const response = await fetch('/admin/api/quota/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                plan_name: planName,
                stock_reports_limit: stockLimit,
                stock_reports_used: usedReports
            })
        });
        
        if (!response.ok) throw new Error('Failed to update user quota');
        
        const data = await response.json();
        alert(data.message || 'User quota updated successfully!');
        
        closeEditModal();
        loadUsers();
    } catch (error) {
        console.error('Error updating user quota:', error);
        alert('Failed to update user quota. Please try again.');
    } finally {
        hideLoading();
    }
}

async function resetUserQuota(userId) {
    if (!confirm('Are you sure you want to reset this user\'s quota to 0?')) return;
    
    showLoading();
    try {
        const response = await fetch('/admin/api/quota/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
        });
        
        if (!response.ok) throw new Error('Failed to reset user quota');
        
        const data = await response.json();
        alert(data.message || 'User quota reset successfully!');
        
        loadUsers();
    } catch (error) {
        console.error('Error resetting user quota:', error);
        alert('Failed to reset user quota. Please try again.');
    } finally {
        hideLoading();
    }
}

function showLoading() {
    document.getElementById('loading-overlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('active');
}

function showError(message) {
    alert(message);
}
</script>
{% endblock %}
