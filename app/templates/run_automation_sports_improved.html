{% extends "_base.html" %}

{% block title %}Sports Article Automation | Tickzen{% endblock %}

{% block head_extra %}
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Automate sports article generation and publishing to WordPress with AI-powered two-stage content creation">
    <link rel="canonical" href="https://tickzen.app/automation-sports">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 0 0% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 0 0% 3.9%;
            --border: 0 0% 89.8%;
            --muted: 0 0% 96.1%;
            --muted-foreground: 0 0% 45.1%;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-600: #16a34a;
            --green-700: #15803d;
            --green-800: #166534;
            --blue-50: #eff6ff;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --orange-50: #fff7ed;
            --orange-600: #ea580c;
            --orange-700: #c2410c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: hsl(var(--foreground));
            background: hsl(var(--background));
            font-size: 14px;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert.alert-warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .alert.alert-danger,
        .alert.alert-error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .alert.alert-success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .automation-layout {
            display: flex;
            min-height: calc(100vh - 120px);
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            gap: 1.5rem;
        }

        .automation-sidebar {
            width: 240px;
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 0;
            height: calc(100vh - 100px);
            position: sticky;
            top: 80px;
            box-shadow: 2px 0 8px 0 rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1.5rem 1.25rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, var(--green-700) 0%, var(--green-800) 100%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0.75rem 0;
            margin: 0;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1.25rem;
            text-decoration: none;
            color: hsl(var(--foreground));
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover {
            background: var(--green-50);
            color: var(--green-700);
            border-left-color: var(--green-600);
        }

        .sidebar-menu a.active {
            background: var(--green-50);
            color: var(--green-700);
            border-left-color: var(--green-600);
            font-weight: 600;
        }

        .automation-content {
            flex: 1;
            min-width: 0;
        }

        .page-header {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-header h1 i {
            color: var(--orange-600);
            font-size: 1.5rem;
        }

        /* Filter Inputs */
        .filter-input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid #cbd5e1; /* Slate-300 for better visibility */
            border-radius: 8px;
            font-size: 0.875rem;
            background-color: white;
            transition: all 0.2s ease;
            outline: none;
            color: hsl(var(--foreground));
        }
        
        .filter-input:hover {
            border-color: #94a3b8; /* Slate-400 */
        }
        
        .filter-input:focus {
            border-color: var(--green-600);
            box-shadow: 0 0 0 3px var(--green-100);
        }
        
        select.filter-input {
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            background-image: none; /* We use custom icon */
        }

        /* Enhanced Filter Styles */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-group-title {
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: hsl(var(--foreground));
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group-title i {
            color: var(--orange-600);
            font-size: 0.875rem;
        }

        .filter-button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .filter-tag-btn {
            padding: 0.6rem 1rem;
            border: 1.5px solid hsl(var(--border));
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            color: hsl(var(--foreground));
            text-align: center;
        }

        .filter-tag-btn:hover {
            border-color: var(--orange-600);
            background: var(--orange-50);
            color: var(--orange-700);
        }

        .filter-tag-btn.active {
            background: var(--orange-600);
            color: white;
            border-color: var(--orange-600);
            box-shadow: 0 2px 8px rgba(234, 88, 12, 0.25);
        }

        .filter-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: hsl(var(--muted));
            cursor: pointer;
        }

        .filter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-600);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(234, 88, 12, 0.4);
            transition: all 0.2s ease;
        }

        .filter-slider::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.6);
            transform: scale(1.1);
        }

        .filter-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--orange-600);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(234, 88, 12, 0.4);
            transition: all 0.2s ease;
        }

        .filter-slider::-moz-range-thumb:hover {
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.6);
            transform: scale(1.1);
        }

        /* Responsive Filter Panel */
        @media (max-width: 768px) {
            #filterDropdownPanel {
                width: calc(100vw - 2rem) !important;
                right: 1rem !important;
                left: 1rem !important;
            }

            .filter-button-group {
                grid-template-columns: 1fr 1fr;
            }

            .filter-two-col-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .filter-button-group {
                grid-template-columns: 1fr;
            }

            .filter-tag-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }

        .filter-slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: hsl(var(--muted));
        }

        .filter-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--orange-600);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }

        .filter-slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--orange-600);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }

        .filter-slider-value {
            min-width: 55px;
            text-align: center;
            font-weight: 600;
            color: var(--orange-600);
            font-size: 0.9rem;
            background: var(--orange-50);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
        }

        .filter-two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .filter-divider {
            height: 1px;
            background: hsl(var(--border));
            margin: 0.5rem 0;
        }

        .filter-info-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--blue-50);
            border-left: 3px solid var(--blue-600);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--blue-700);
        }

        .filter-info-badge i {
            flex-shrink: 0;
            color: var(--blue-600);
        }

        /* Category Filters */
        .category-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .category-section h3 {
            font-size: 1.0625rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: hsl(var(--foreground));
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .category-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid hsl(var(--border));
            background: white;
            color: hsl(var(--foreground));
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-btn:hover {
            border-color: var(--orange-600);
            color: var(--orange-700);
            background: var(--orange-50);
        }

        .category-btn.active {
            background: var(--orange-600);
            color: white;
            border-color: var(--orange-600);
        }

        /* Action Buttons */
        .actions-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            padding: 1rem;
            border: 2px solid hsl(var(--border));
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .action-btn i {
            font-size: 2rem;
            color: var(--green-600);
        }

        .action-btn:hover {
            border-color: var(--green-600);
            background: var(--green-50);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.15);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Display */
        .progress-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: hsl(var(--muted));
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--green-600), var(--green-700));
            transition: width 0.3s ease;
            width: 0%;
        }

        .completion-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--green-50);
            color: var(--green-700);
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .progress-log {
            background: #1f2937;
            color: #d1d5db;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            line-height: 1.6;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-left: 3px solid transparent;
            padding-left: 0.5rem;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            color: #93c5fd;
        }

        .log-entry.success {
            border-left-color: #10b981;
            color: #6ee7b7;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
            color: #fcd34d;
        }

        .log-entry {
            margin: 0.25rem 0;
        }

        .log-entry.info { color: #60a5fa; }
        .log-entry.success { color: #34d399; }
        .log-entry.error { color: #f87171; }
        .log-entry.warning { color: #fbbf24; }

        /* Articles Grid */
        .articles-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* View Mode Switcher */
        .view-switcher {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: hsl(var(--muted));
            border-radius: 8px;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid hsl(var(--border));
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-btn:hover {
            background: var(--blue-50);
            border-color: var(--blue-600);
        }

        .view-btn.active {
            background: var(--blue-600);
            color: white;
            border-color: var(--blue-600);
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Card View (Default) */
        .article-card {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .article-card:hover {
            border-color: var(--orange-600);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.15);
            transform: translateY(-2px);
        }

        .article-card.selected {
            border-color: var(--green-600);
            background: var(--green-50);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.15);
        }

        .article-card .select-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 24px;
            height: 24px;
            border: 2px solid hsl(var(--border));
            border-radius: 4px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .article-card.selected .select-indicator {
            background: var(--green-600);
            border-color: var(--green-600);
            color: white;
        }

        .article-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            padding-right: 2.5rem;
            color: hsl(var(--foreground));
        }

        .article-summary {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.75rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-meta {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .article-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .article-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-critical { background: #fee2e2; color: #991b1b; }
        .badge-high { background: #fef3c7; color: #92400e; }
        .badge-medium { background: #dbeafe; color: #1e40af; }
        .badge-low { background: #e0e7ff; color: #3730a3; }
        .badge-minimal { background: #f3f4f6; color: #374151; }
        .badge-category { background: var(--green-100); color: var(--green-800); }
        .badge-source { background: hsl(var(--muted)); color: hsl(var(--foreground)); }
        .badge-score { background: var(--blue-50); color: var(--blue-700); font-weight: 600; }

        /* Tile View */
        .articles-grid.tile-view {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .articles-grid.tile-view .article-card {
            padding: 1rem;
        }

        .articles-grid.tile-view .article-title {
            font-size: 0.9rem;
        }

        .articles-grid.tile-view .article-summary {
            -webkit-line-clamp: 3;
        }

        /* List View */
        .articles-grid.list-view {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .articles-grid.list-view .article-card {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .articles-grid.list-view .select-indicator {
            position: static;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .articles-grid.list-view .article-content {
            flex: 1;
        }

        .articles-grid.list-view .article-title {
            font-size: 0.95rem;
            padding-right: 0;
        }

        .articles-grid.list-view .article-summary {
            -webkit-line-clamp: 1;
        }

        /* Dropdown/Accordion View */
        .articles-grid.dropdown-view {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .articles-grid.dropdown-view .article-card {
            padding: 0;
            overflow: hidden;
        }

        .article-dropdown-header {
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            transition: background 0.2s;
        }

        .article-dropdown-header:hover {
            background: var(--blue-50);
        }

        .article-dropdown-header-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .article-dropdown-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: hsl(var(--muted-foreground));
            transition: transform 0.2s;
        }

        .article-card.expanded .article-dropdown-toggle {
            transform: rotate(180deg);
        }

        .article-dropdown-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: hsl(var(--muted));
        }

        .article-card.expanded .article-dropdown-body {
            max-height: 2000px;
        }

        .article-dropdown-content {
            padding: 1.25rem;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .metadata-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: hsl(var(--muted-foreground));
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .metadata-value {
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            word-break: break-word;
        }

        .scoring-breakdown {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .scoring-breakdown h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .score-label {
            color: hsl(var(--muted-foreground));
        }

        .score-value {
            font-weight: 600;
            color: var(--blue-600);
        }

        /* Profile Cards */
        .profiles-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .profile-card {
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--orange-700) 0%, var(--orange-600) 100%);
            padding: 1rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: white;
        }

        .profile-body {
            padding: 1.25rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid hsl(var(--border));
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: inherit;
            color: hsl(var(--foreground));
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--orange-600);
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        /* Publish Button */
        .publish-section {
            background: white;
            border: 1px solid hsl(var(--border));
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .btn-publish {
            padding: 1rem 3rem;
            border: none;
            background: var(--orange-600);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .btn-publish:hover {
            background: var(--orange-700);
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .btn-publish:disabled {
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block content %}
<div class="automation-layout">
    <aside class="automation-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-robot"></i>
            Automation Menu
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="{{ url_for('automation_runner_page') }}">
                    <i class="fas fa-chart-line"></i>
                    <span>Stock Analysis</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('automation_earnings_runner') }}">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Earnings Report</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('automation_sports_runner') }}" class="active">
                    <i class="fas fa-football-ball"></i>
                    <span>Sports Article</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('trends_dashboard') }}">
                    <i class="fas fa-fire"></i>
                    <span>Google Trends</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('publishing_history') }}">
                    <i class="fas fa-history"></i>
                    <span>Publishing History</span>
                </a>
            </li>
        </ul>
        <div style="border-top: 1px solid hsl(var(--border)); padding: 1rem;">
            <a href="{{ url_for('manage_site_profiles') }}" style="display: flex; align-items: center; gap: 0.625rem; padding: 0.75rem; text-decoration: none; color: hsl(var(--foreground)); font-size: 0.875rem; font-weight: 500; background: white; border: 1px solid hsl(var(--border)); border-radius: 8px; transition: all 0.2s ease;">
                <i class="fas fa-cog" style="color: var(--green-600);"></i>
                <span>Manage Profiles</span>
            </a>
        </div>
    </aside>

    <div class="automation-content">
        <div class="page-header">
            <h1><i class="fas fa-football-ball"></i> Sports Article Automation</h1>
            <p style="color: hsl(var(--muted-foreground)); margin: 0;">
                AI-powered two-stage article generation (Perplexity Research + Gemini Writing) for Cricket, Football, and Basketball
            </p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="margin-bottom: 1rem;">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}" style="padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; color: #1f2937;">
                            <i class="fas {% if category == 'warning' %}fa-exclamation-triangle{% elif category == 'danger' or category == 'error' %}fa-times-circle{% else %}fa-check-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Category Filter -->
        <div class="category-section">
            <h3><i class="fas fa-filter"></i> Select Sports Category</h3>
            <div class="category-buttons">
                <button type="button" class="category-btn active" data-category="all" onclick="filterByCategory('all')">
                    <i class="fas fa-globe"></i>
                    All Sports
                </button>
                <button type="button" class="category-btn" data-category="cricket" onclick="filterByCategory('cricket')">
                    <i class="fas fa-cricket"></i>
                    Cricket
                </button>
                <button type="button" class="category-btn" data-category="football" onclick="filterByCategory('football')">
                    <i class="fas fa-football-ball"></i>
                    Football
                </button>
                <button type="button" class="category-btn" data-category="basketball" onclick="filterByCategory('basketball')">
                    <i class="fas fa-basketball-ball"></i>
                    Basketball
                </button>
            </div>
        </div>



        <!-- Action Buttons -->
        <div class="actions-section">
            <h3 style="font-size: 1.0625rem; font-weight: 600; margin-bottom: 1rem; color: hsl(var(--foreground)); display: flex; align-items: center; gap: 0.625rem;">
                <i class="fas fa-bolt" style="color: var(--orange-600);"></i>
                Quick Actions
            </h3>
            <div class="actions-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">
                <button type="button" class="action-btn" onclick="collectRSS()" id="collectBtn" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1.25rem; background: white; border: 1px solid hsl(var(--border)); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: left; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 10px; background: var(--blue-50); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-cloud-download-alt" style="font-size: 1.5rem; color: var(--blue-600);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; color: hsl(var(--foreground)); margin-bottom: 0.25rem;">Collect RSS Articles</div>
                            <small style="color: hsl(var(--muted-foreground)); font-size: 0.85rem; line-height: 1.4; display: block;">Fetch the latest headlines from all configured sports sources</small>
                        </div>
                    </div>
                    <div id="lastUpdatedInfo" style="display: block; margin-top: 0.5rem;">
                        <small style="color: #6b7280; font-size: 0.7rem; line-height: 1.4; display: block;">
                            Last updated: <span id="lastUpdatedTimestamp" style="color: #6b7280;">Never</span>
                        </small>
                    </div>
                </button>
                
                <button type="button" class="action-btn" onclick="runAutomation()" id="runAutomationBtn" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1.25rem; background: white; border: 1px solid hsl(var(--border)); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: left; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-magic" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; color: hsl(var(--foreground)); margin-bottom: 0.25rem;">Run Automation</div>
                            <small style="color: hsl(var(--muted-foreground)); font-size: 0.85rem; line-height: 1.4; display: block;">Generate AI articles and publish to WordPress sites</small>
                        </div>
                    </div>
                    <div style="display: block; margin-top: 0.5rem;">
                        <small style="color: #6b7280; font-size: 0.7rem; line-height: 1.4; display: block;">
                            <span id="selectedCountDisplay">Select articles to run</span>
                        </small>
                    </div>
                </button>
                
                <button type="button" class="action-btn" onclick="refreshArticles()" id="refreshBtn" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: white; border: 1px solid hsl(var(--border)); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: left; width: 100%;">
                    <div style="width: 48px; height: 48px; border-radius: 10px; background: var(--green-50); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-sync-alt" style="font-size: 1.5rem; color: var(--green-600);"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 1rem; color: hsl(var(--foreground)); margin-bottom: 0.25rem;">Refresh List</div>
                        <small style="color: hsl(var(--muted-foreground)); font-size: 0.85rem; line-height: 1.4; display: block;">Reload the article database to see newly collected items</small>
                    </div>
                </button>
            </div>
        </div>

        <!-- Progress Display -->
        <div class="progress-section" id="progressSection">
            <h3 style="font-size: 1.0625rem; font-weight: 600; margin-bottom: 1rem; color: hsl(var(--foreground)); display: flex; align-items: center; gap: 0.625rem;">
                <i class="fas fa-spinner fa-spin" style="color: var(--blue-600);"></i>
                <span id="progressTitle">Processing...</span>
            </h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="completionScoreContainer" style="display: none;">
                <span class="completion-badge" id="completionBadge">
                    <i class="fas fa-trophy"></i>
                    Completion Score: <strong id="completionScore">0</strong>%
                </span>
                <div id="categoryBreakdown" style="margin-top: 0.75rem; font-size: 0.875rem; color: hsl(var(--muted-foreground));"></div>
            </div>
            <div class="progress-log" id="progressLog"></div>
        </div>

        <!-- Articles Display -->
        <div class="articles-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <h3 style="font-size: 1.0625rem; font-weight: 600; color: hsl(var(--foreground)); display: flex; align-items: center;">
                    <i class="fas fa-newspaper" style="color: var(--orange-600); margin-right: 0.5rem;"></i> Available Articles
                    <span id="articleCount" style="font-size: 0.875rem; font-weight: 500; color: hsl(var(--muted-foreground)); margin-left: 1rem;">
                        <span id="selectedCount">0</span> selected / <span id="totalCount">{{ sports_articles|length }}</span> total
                    </span>
                </h3>
                
                <div class="view-switcher" style="position: relative;">
                    <button class="view-btn active" data-view="card" onclick="switchView('card')">
                        <i class="fas fa-th-large"></i> Cards
                    </button>
                    <button class="view-btn" data-view="tile" onclick="switchView('tile')">
                        <i class="fas fa-th"></i> Tiles
                    </button>
                    <button class="view-btn" data-view="list" onclick="switchView('list')">
                        <i class="fas fa-list"></i> List
                    </button>
                    <button class="view-btn" data-view="dropdown" onclick="switchView('dropdown')">
                        <i class="fas fa-bars"></i> Dropdown
                    </button>
                    
                    <div style="width: 1px; height: 24px; background: hsl(var(--border)); margin: 0 0.5rem;"></div>
                    
                    <button class="view-btn" onclick="toggleFiltersDropdown()" id="filterDropdownBtn">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                    
                    <!-- Filter Dropdown Panel - Improved -->
                    <div id="filterDropdownPanel" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; background: white; border: 1px solid hsl(var(--border)); border-radius: 12px; padding: 0; box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15); width: 420px; max-width: calc(100vw - 2rem); z-index: 50; overflow: hidden;">
                        
                        <!-- Header -->
                        <div style="padding: 1.25rem; border-bottom: 1px solid hsl(var(--border)); background: linear-gradient(135deg, var(--orange-50) 0%, hsl(var(--muted)) 100%); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: 1rem; font-weight: 700; margin: 0; color: hsl(var(--foreground)); display: flex; align-items: center; gap: 0.625rem;">
                                <i class="fas fa-sliders-h" style="color: var(--orange-600);"></i> Smart Filters
                            </h3>
                            <button onclick="toggleFiltersDropdown()" style="background: none; border: none; color: hsl(var(--muted-foreground)); cursor: pointer; padding: 0.25rem; transition: all 0.2s; font-size: 1.2rem;" onmouseover="this.style.color='var(--orange-600)'" onmouseout="this.style.color='hsl(var(--muted-foreground))'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="filter-section" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; max-height: calc(100vh - 300px); overflow-y: auto;">
                            
                            <!-- Score Based Filter -->
                            <div class="filter-group">
                                <div class="filter-group-title">
                                    <i class="fas fa-chart-line"></i> Article Score
                                </div>
                                <div class="filter-slider-container">
                                    <input type="range" id="filterMinScoreRange" class="filter-slider" min="0" max="100" step="1" value="0" oninput="syncScoreInput(this.value)">
                                    <div class="filter-slider-value" id="filterScoreDisplay">0</div>
                                </div>
                                <small style="color: hsl(var(--muted-foreground)); font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> Shows articles with score ≥ <strong id="filterScoreValue">0</strong> (0-100)
                                </small>
                            </div>

                            <!-- Importance Filter -->
                            <div class="filter-group">
                                <div class="filter-group-title">
                                    <i class="fas fa-star"></i> Importance Level
                                </div>
                                <div class="filter-button-group">
                                    <button type="button" class="filter-tag-btn" data-importance="critical" onclick="toggleImportanceFilter('critical')">
                                        <i class="fas fa-circle" style="color: #dc2626; font-size: 0.6rem;"></i> Critical
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-importance="high" onclick="toggleImportanceFilter('high')">
                                        <i class="fas fa-circle" style="color: #f97316; font-size: 0.6rem;"></i> High
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-importance="medium" onclick="toggleImportanceFilter('medium')">
                                        <i class="fas fa-circle" style="color: #eab308; font-size: 0.6rem;"></i> Medium
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-importance="low" onclick="toggleImportanceFilter('low')">
                                        <i class="fas fa-circle" style="color: #3b82f6; font-size: 0.6rem;"></i> Low
                                    </button>
                                </div>
                                <small style="color: hsl(var(--muted-foreground)); font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> Click to toggle multiple levels
                                </small>
                            </div>

                            <!-- Time Based Filter -->
                            <div class="filter-group">
                                <div class="filter-group-title">
                                    <i class="fas fa-clock"></i> Time Range
                                </div>
                                <div class="filter-button-group">
                                    <button type="button" class="filter-tag-btn" data-time="latest" onclick="toggleTimeFilter('latest')">
                                        <i class="fas fa-bolt"></i> Latest
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-time="last_6h" onclick="toggleTimeFilter('last_6h')">
                                        <i class="fas fa-history"></i> Last 6h
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-time="last_24h" onclick="toggleTimeFilter('last_24h')">
                                        <i class="fas fa-sun"></i> Last 24h
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-time="older" onclick="toggleTimeFilter('older')">
                                        <i class="fas fa-calendar-alt"></i> Older
                                    </button>
                                </div>
                            </div>

                            <!-- Source Quality Filter -->
                            <div class="filter-group">
                                <div class="filter-group-title">
                                    <i class="fas fa-shield-alt"></i> Trusted Sources
                                </div>
                                <div class="filter-button-group">
                                    <button type="button" class="filter-tag-btn" data-source="premium" onclick="toggleSourceFilter('premium')">
                                        <i class="fas fa-crown"></i> Premium
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-source="verified" onclick="toggleSourceFilter('verified')">
                                        <i class="fas fa-check-circle"></i> Verified
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-source="standard" onclick="toggleSourceFilter('standard')">
                                        <i class="fas fa-star-half-alt"></i> Standard
                                    </button>
                                    <button type="button" class="filter-tag-btn" data-source="emerging" onclick="toggleSourceFilter('emerging')">
                                        <i class="fas fa-rocket"></i> Emerging
                                    </button>
                                </div>
                            </div>

                            <!-- Results Limit -->
                            <div class="filter-group">
                                <div class="filter-group-title">
                                    <i class="fas fa-list-ol"></i> Display Options
                                </div>
                                <div class="filter-two-col-grid">
                                    <div>
                                        <label style="font-size: 0.8rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem; display: block;">Max Results</label>
                                        <input type="number" id="filterLimit" class="filter-input" min="1" max="500" value="50" placeholder="50">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem; display: block;">Sort By</label>
                                        <select id="filterSort" class="filter-input">
                                            <option value="score_desc">Score (High → Low)</option>
                                            <option value="score_asc">Score (Low → High)</option>
                                            <option value="newest">Newest First</option>
                                            <option value="oldest">Oldest First</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-divider"></div>

                            <!-- Active Filters Summary -->
                            <div id="activeFiltersSummary" style="display: none;">
                                <div class="filter-info-badge">
                                    <i class="fas fa-filter"></i>
                                    <span id="activeFiltersText">Filters: None active</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div style="padding: 1.25rem; border-top: 1px solid hsl(var(--border)); background: hsl(var(--muted)); display: flex; gap: 0.75rem;">
                            <button type="button" onclick="resetFilters();" style="flex: 1; padding: 0.75rem; background: white; color: hsl(var(--foreground)); border: 1px solid hsl(var(--border)); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-undo" style="font-size: 0.875rem;"></i> Reset All
                            </button>
                            <button type="button" onclick="applyAdvancedFilters(); toggleFiltersDropdown();" style="flex: 2; padding: 0.75rem; background: var(--orange-600); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 2px 8px rgba(234, 88, 12, 0.3);">
                                <i class="fas fa-check" style="font-size: 0.875rem;"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="articles-grid" id="articlesGrid" data-current-view="card">
                {% if sports_articles and sports_articles|length > 0 %}
                    {% for article in sports_articles %}
                    <div class="article-card" 
                         data-article-id="{{ article.id }}" 
                         data-category="{{ article.category }}"
                         data-importance="{{ article.importance_tier|default('Medium') }}"
                         data-score="{{ article.importance_score|default(50) }}"
                         data-published="{{ article.published_date }}"
                         data-title="{{ article.title }}"
                         data-url="{{ article.link or article.url or '' }}">
                        
                        <div class="select-indicator" onclick="toggleArticleSelection(this.parentElement)">
                            <i class="fas fa-check"></i>
                        </div>
                        
                        <div class="article-dropdown-header" style="display: none;" onclick="toggleDropdown(this.parentElement)">
                            <div class="article-dropdown-header-content">
                                <div class="select-indicator" onclick="event.stopPropagation(); toggleArticleSelection(this.closest('.article-card'))">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div>
                                    <h4 class="article-title" style="margin: 0;">{{ article.title }}</h4>
                                    <div class="article-meta" style="margin-top: 0.25rem;">
                                        <span class="article-meta-item">
                                            <i class="fas fa-tag"></i> {{ article.category|title }}
                                        </span>
                                        <span class="article-meta-item">
                                            <i class="fas fa-star"></i> {{ article.importance_tier|default('Medium') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="article-dropdown-toggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        
                        <div class="article-content" onclick="toggleArticleSelection(this.parentElement)">
                            <h4 class="article-title">{{ article.title }}</h4>
                            
                            <p class="article-summary">{{ article.summary|default('No summary available')|truncate(200) }}</p>
                            
                    <div class="article-meta">
                        <span class="article-meta-item">
                            <i class="fas fa-clock"></i>
                            {{ article.published_date|default('Unknown Date') }}
                        </span>
                        <span class="article-meta-item">
                            <i class="fas fa-user"></i>
                            {{ article.author|default('Unknown Author') }}
                        </span>
                    </div>                            <div class="article-badges">
                                <span class="badge badge-category">
                                    <i class="fas fa-tag"></i> {{ article.category|title }}
                                </span>
                                <span class="badge badge-{{ article.importance_tier|default('medium')|lower }}">
                                    <i class="fas fa-star"></i> {{ article.importance_tier|default('Medium') }}
                                </span>
                                <span class="badge badge-score">
                                    <i class="fas fa-chart-line"></i> {{ article.importance_score|default(50)|round(1) }}
                                </span>
                                <span class="badge badge-source">
                                    <i class="fas fa-clock"></i> {{ article.time_bracket|default('recent')|replace('_', ' ')|title }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="article-dropdown-body">
                            <div class="article-dropdown-content">
                                <div class="metadata-grid">
                                    <div class="metadata-item">
                                        <span class="metadata-label">Article ID</span>
                                        <span class="metadata-value">{{ article.id }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">Importance Score</span>
                                        <span class="metadata-value">{{ article.importance_score|default(0)|round(2) }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">Hybrid Rank</span>
                                        <span class="metadata-value">#{{ article.hybrid_rank|default('N/A') }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">Time Bracket</span>
                                        <span class="metadata-value">{{ article.time_bracket|default('recent')|replace('_', ' ')|title }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">Collected Date</span>
                                        <span class="metadata-value">{{ article.collected_date|default('Unknown') }}</span>
                                    </div>
                                    <div class="metadata-item">
                                        <span class="metadata-label">Source URL</span>
                                        <span class="metadata-value">
                                            <a href="{{ article.link or article.url }}" target="_blank" style="color: var(--blue-600); text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i> View Source
                                            </a>
                                        </span>
                                    </div>
                                </div>
                                
                                {% if article.scoring_breakdown %}
                                <div class="scoring-breakdown">
                                    <h4><i class="fas fa-calculator"></i> Scoring Breakdown</h4>
                                    <div class="scoring-grid">
                                        <div class="score-item">
                                            <span class="score-label">Content Score:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.content_score|default(0)|round(1) }}</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Source Authority:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.source_authority|default(0)|round(1) }}</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Temporal Factor:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.temporal_factor|default(0)|round(1) }}</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Engagement Predictor:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.engagement_predictor|default(0)|round(1) }}</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Category Multiplier:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.category_multiplier|default(1)|round(2) }}</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-label">Trending Boost:</span>
                                            <span class="score-value">{{ article.scoring_breakdown.trending_boost|default(0)|round(1) }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid hsl(var(--border));">
                                    <p style="font-size: 0.875rem; line-height: 1.6; color: hsl(var(--foreground));">{{ article.summary|default('No summary available') }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 3rem; color: hsl(var(--muted-foreground));">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--orange-600);"></i>
                        <p style="font-weight: 600; margin-top: 1rem; color: hsl(var(--foreground));">No articles available</p>
                        <p style="margin-top: 0.5rem;">Click "Collect RSS Articles" to fetch the latest content</p>
                    </div>
                {% endif %}
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 1rem; background: white; border: 1px solid hsl(var(--border)); border-radius: 12px;">
                <div class="items-per-page">
                    <label for="itemsPerPage" style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-right: 0.5rem;">Items per page:</label>
                    <select id="itemsPerPage" onchange="changeItemsPerPage(this.value)" style="padding: 0.25rem 0.5rem; border: 1px solid hsl(var(--border)); border-radius: 4px;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div class="pagination-info" style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                    Showing <span id="showingStart">1</span> - <span id="showingEnd">10</span> of <span id="showingTotal">0</span> articles
                </div>
                <div class="pagination-buttons" style="display: flex; gap: 0.5rem; align-items: center;">
                    <button onclick="changePage(1)" id="firstPageBtn" class="category-btn" style="padding: 0.5rem 1rem;" title="First page">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button onclick="changePage(currentPage - 1)" id="prevPageBtn" class="category-btn" style="padding: 0.5rem 1rem;" title="Previous page">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo" style="font-size: 0.875rem; font-weight: 500;">Page 1 of 1</span>
                    <button onclick="changePage(currentPage + 1)" id="nextPageBtn" class="category-btn" style="padding: 0.5rem 1rem;" title="Next page">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button onclick="changePage(totalPages)" id="lastPageBtn" class="category-btn" style="padding: 0.5rem 1rem;" title="Last page">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Selection -->
        {% if user_site_profiles and user_site_profiles|length > 0 %}
        <div class="profiles-section">
            <h3 style="font-size: 1.0625rem; font-weight: 600; margin-bottom: 0.5rem; color: hsl(var(--foreground)); display: flex; align-items: center; gap: 0.625rem;">
                <i class="fas fa-bullseye" style="color: var(--orange-600);"></i>
                Select WordPress Sites
            </h3>
            <div class="profiles-grid">
                {% for profile in user_site_profiles %}
                <div class="profile-card" data-profile-id="{{ profile.profile_id }}">
                    <div class="profile-header">
                        <input type="checkbox" id="profile_{{ profile.profile_id }}" class="profile-checkbox" value="{{ profile.profile_id }}">
                        <label for="profile_{{ profile.profile_id }}" style="flex: 1; cursor: pointer; font-weight: 600; margin: 0;">
                            {{ profile.profile_name }}
                        </label>
                    </div>
                    <div class="profile-body">
                        <p style="font-size: 0.875rem; margin-bottom: 0.75rem; color: hsl(var(--muted-foreground));">
                            <a href="{{ profile.site_url }}" target="_blank" style="color: var(--blue-600); text-decoration: none;">{{ profile.site_url }}</a>
                        </p>
                        
                        <div class="form-group">
                            <label for="category_id_{{ profile.profile_id }}">
                                <i class="fas fa-folder-open"></i> WordPress Category ID (Dynamic)
                            </label>
                            <input type="number" class="form-control" id="category_id_{{ profile.profile_id }}" name="category_id_{{ profile.profile_id }}" placeholder="e.g., 6 (Cricket), 7 (Football), 8 (Basketball)" min="1">
                            <small class="form-text text-muted">
                                <strong>Dynamic Category Selection:</strong> Enter category ID for this run (e.g., Cricket=6, Football=7, Basketball=8)<br>
                                <em>Leave blank to use profile's default category or system fallback</em>
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="publish_status_{{ profile.profile_id }}">
                                <i class="fas fa-toggle-on"></i> Publish Status
                            </label>
                            <select class="form-control" id="publish_status_{{ profile.profile_id }}" name="publish_status_{{ profile.profile_id }}">
                                <option value="publish">Publish Immediately</option>
                                <option value="future">Schedule for Later</option>
                                <option value="draft">Save as Draft</option>
                            </select>
                        </div>

                        {% if profile.authors and profile.authors|length > 0 %}
                        <div style="background: hsl(var(--muted)); padding: 0.75rem; border-radius: 6px; font-size: 0.875rem;">
                            <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: hsl(var(--foreground));">
                                <i class="fas fa-users"></i> {{ profile.authors|length }} Author{{ 's' if profile.authors|length > 1 else '' }}
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                                {% for author in profile.authors[:3] %}
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: hsl(var(--muted-foreground));">
                                    <i class="fas fa-user-circle" style="color: var(--blue-600);"></i>
                                    <span>{{ author.wp_username or author.wp_user_id }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <p style="color: var(--orange-600); font-size: 0.875rem; font-weight: 500;">
                            <i class="fas fa-exclamation-triangle"></i> No authors configured
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>


        {% else %}
        <div style="background: white; border: 1px solid hsl(var(--border)); border-radius: 12px; padding: 3rem; text-align: center;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--orange-600);"></i>
            <p style="font-weight: 600; margin-top: 1rem; color: hsl(var(--foreground));">No WordPress Profiles Configured</p>
            <p style="margin-top: 0.5rem; color: hsl(var(--muted-foreground));">Please configure at least one WordPress profile to use automation</p>
            <a href="{{ url_for('manage_site_profiles') }}" style="display: inline-flex; align-items: center; gap: 0.75rem; margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--orange-600); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                <i class="fas fa-plus-circle"></i>
                Add Profile
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    // Initialize SocketIO
    const socket = io();
    let selectedArticles = [];
    let selectedProfiles = [];
    let currentCategory = 'all';

    // Pagination State
    let currentPage = 1;
    let itemsPerPage = 20;
    let allArticleCards = []; // Stores DOM elements
    let filteredArticleCards = []; // Stores currently filtered DOM elements
    let totalPages = 1;

    // Connect to SocketIO room
    socket.on('connect', function() {
        console.log('Connected to SocketIO');
        socket.emit('join_task_room', {room: '{{ session.get("firebase_user_uid") }}'});
    });

    // Listen for sports automation updates
    socket.on('sports_automation_update', function(data) {
        // Check if this is a completion message
        if (data.level === 'complete' || (data.level === 'success' && data.message.includes('Complete!')) || data.message.includes('Complete workflow') || data.message.includes('Automation pipeline started')) {
            handleAutomationComplete(data);
            return;
        }
        
        addLogEntry(data.message, data.level);
        if (data.stage) {
            document.getElementById('progressTitle').textContent = formatStageTitle(data.stage);
        }
        
        // Update progress bar if progress data is available
        if (typeof data.progress !== 'undefined') {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = data.progress + '%';
            }
        }
        
        // Show completion score and category breakdown if available
        if (data.completion_score) {
            const scoreContainer = document.getElementById('completionScoreContainer');
            const scoreElement = document.getElementById('completionScore');
            const breakdownElement = document.getElementById('categoryBreakdown');
            
            if (scoreContainer && scoreElement) {
                scoreElement.textContent = data.completion_score;
                scoreContainer.style.display = 'block';
            }
            
            if (data.category_breakdown && breakdownElement) {
                let breakdownHTML = '<strong>Articles by Category:</strong> ';
                const categories = Object.entries(data.category_breakdown)
                    .map(([cat, count]) => `${cat.charAt(0).toUpperCase() + cat.slice(1)}: ${count}`)
                    .join(' | ');
                breakdownElement.innerHTML = breakdownHTML + categories;
            }
        }
        
        // Store last article info if available
        if (data.last_article) {
            window.lastArticleData = data.last_article;
        }
    });

    // Handle automation completion without full page reload
    function handleAutomationComplete(data) {
        const logContainer = document.getElementById('progressLog');
        
        // Clear all logs
        logContainer.innerHTML = '';
        
        // Add only the completion summary
        const completionEntry = document.createElement('div');
        completionEntry.className = 'log-entry success';
        const timestamp = new Date().toLocaleTimeString();
        
        let summaryText = `[${timestamp}] ✅ Automation Complete!`;
        
        // Add article and writer info if available
        if (window.lastArticleData) {
            const writer = window.lastArticleData.writer || window.lastArticleData.author || 'Auto-assigned';
            const publishTime = window.lastArticleData.publish_time || 'Just now';
            summaryText += ` | Article: ${window.lastArticleData.title.substring(0, 50)}... | Writer: ${writer} | Time: ${publishTime}`;
        }
        
        completionEntry.textContent = summaryText;
        logContainer.appendChild(completionEntry);
        
        // Update UI after 2 seconds
        setTimeout(() => {
            const btn = document.getElementById('runAutomationBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<div style="display: flex; align-items: center; gap: 1rem;"><div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i class="fas fa-magic" style="font-size: 1.5rem; color: white;"></i></div><div style="flex: 1;"><div style="font-weight: 600; font-size: 1rem; color: hsl(var(--foreground)); margin-bottom: 0.25rem;">Run Automation</div><small style="color: hsl(var(--muted-foreground)); font-size: 0.85rem; line-height: 1.4; display: block;">Generate AI articles and publish to WordPress sites</small></div></div>';
            }
            
            // Clear all selections and state immediately after automation completes
            clearAllSelectionsAndState();
            
            // Auto-refresh articles after 3 seconds WITHOUT full page reload
            setTimeout(() => {
                refreshArticlesWithoutReload();
            }, 3000);
        }, 2000);
    }

    function formatStageTitle(stage) {
        const titles = {
            'rss_collection': 'Collecting RSS Articles',
            'generation': 'Generating AI Article',
            'publishing': 'Publishing to WordPress'
        };
        return titles[stage] || 'Processing...';
    }

    function addLogEntry(message, level) {
        const log = document.getElementById('progressLog');
        const entry = document.createElement('div');
        entry.className = `log-entry ${level || 'info'}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function showProgress() {
        document.getElementById('progressSection').classList.add('active');
        document.getElementById('progressLog').innerHTML = '';
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('completionScoreContainer').style.display = 'none';
    }

    function hideProgress() {
        document.getElementById('progressSection').classList.remove('active');
    }

    function showSuccessNotification(title, message, data = {}) {
        // Create success notification popup
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border: 2px solid var(--green-600);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(22, 163, 74, 0.2);
            z-index: 10000;
            max-width: 450px;
            animation: slideInRight 0.3s ease;
        `;
        
        // Build category breakdown HTML
        let categoriesHTML = '';
        if (data.categories) {
            categoriesHTML = `
                <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); padding: 0.5rem; background: var(--green-50); border-radius: 6px; margin-bottom: 0.5rem;">
                    <strong>Categories:</strong> ${Object.entries(data.categories).map(([cat, count]) => `${cat}: ${count}`).join(' | ')}
                </div>
            `;
        }
        
        // Build last article HTML
        let lastArticleHTML = '';
        if (data.last_article && data.last_article.title) {
            lastArticleHTML = `
                <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); padding: 0.5rem; background: var(--blue-50); border-radius: 6px; border-left: 3px solid var(--blue-600);">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i class="fas fa-newspaper" style="color: var(--blue-600); margin-top: 0.15rem;"></i>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 0.25rem;">Latest Article:</strong>
                            <span style="display: block; font-size: 0.7rem; line-height: 1.3;">${data.last_article.title.substring(0, 80)}${data.last_article.title.length > 80 ? '...' : ''}</span>
                            <span style="display: block; font-size: 0.65rem; margin-top: 0.25rem; opacity: 0.8;">Source: ${data.last_article.source}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        notification.innerHTML = `
            <div style="display: flex; align-items: start; gap: 1rem;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--green-50); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-check-circle" style="font-size: 1.5rem; color: var(--green-600);"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; color: hsl(var(--foreground));">${title}</h4>
                    <p style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: hsl(var(--muted-foreground)); line-height: 1.5;">${message}</p>
                    ${categoriesHTML}
                    ${lastArticleHTML}
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: hsl(var(--muted-foreground));">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 6 seconds (increased for more content)
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 6000);
    }

    // Add animation keyframes
    if (!document.getElementById('notificationAnimations')) {
        const style = document.createElement('style');
        style.id = 'notificationAnimations';
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // View Switching
    function switchView(viewMode) {
        const grid = document.getElementById('articlesGrid');
        const currentView = grid.dataset.currentView;
        
        if (currentView === viewMode) return;
        
        // Update grid class
        grid.classList.remove('card-view', 'tile-view', 'list-view', 'dropdown-view');
        grid.classList.add(viewMode + '-view');
        grid.dataset.currentView = viewMode;
        
        // Update button states
        document.querySelectorAll('.view-btn').forEach(btn => {
            if (btn.dataset.view === viewMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Toggle dropdown headers visibility
        const cards = document.querySelectorAll('.article-card');
        cards.forEach(card => {
            const header = card.querySelector('.article-dropdown-header');
            const content = card.querySelector('.article-content');
            
            if (viewMode === 'dropdown') {
                header.style.display = 'flex';
                content.style.display = 'none';
                card.classList.remove('expanded');
            } else {
                header.style.display = 'none';
                content.style.display = 'block';
            }
        });
    }

    // Toggle dropdown in dropdown view
    function toggleDropdown(card) {
        if (card.classList.contains('expanded')) {
            card.classList.remove('expanded');
        } else {
            card.classList.add('expanded');
        }
    }

    // Pagination Functions
    function initPagination() {
        // Capture all initial article cards
        const grid = document.getElementById('articlesGrid');
        // Only capture if we haven't already (or if it's a fresh load)
        // But wait, if the grid has "No articles" message, querySelectorAll will be empty, which is correct.
        // However, we need to distinguish between "No articles loaded" and "No articles match filter".
        // On initial load, if there are articles, they are in the DOM.
        
        const cards = Array.from(grid.querySelectorAll('.article-card'));
        if (cards.length > 0) {
            allArticleCards = cards;
            filteredArticleCards = [...allArticleCards];
            renderPage(1);
        } else {
            // If no cards, check if it's empty state
            allArticleCards = [];
            filteredArticleCards = [];
            updatePaginationControls();
        }
    }

    function changeItemsPerPage(val) {
        itemsPerPage = parseInt(val);
        renderPage(1);
    }

    function changePage(page) {
        totalPages = Math.ceil(filteredArticleCards.length / itemsPerPage) || 1;
        if (page < 1 || page > totalPages) return;
        renderPage(page);
    }

    function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredArticleCards.slice(start, end);
        
        const grid = document.getElementById('articlesGrid');
        
        if (filteredArticleCards.length === 0) {
             grid.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: hsl(var(--muted-foreground));">
                    <i class="fas fa-inbox" style="font-size: 3rem; color: var(--orange-600);"></i>
                    <p style="font-weight: 600; margin-top: 1rem; color: hsl(var(--foreground));">No articles match your filters</p>
                </div>
            `;
        } else {
            grid.innerHTML = '';
            pageItems.forEach(card => {
                card.style.display = ''; // Ensure visible
                grid.appendChild(card);
            });
        }
        
        updatePaginationControls();
        
        // Update total count display
        document.getElementById('totalCount').textContent = filteredArticleCards.length;
        
        // Update selected count
        document.getElementById('selectedCount').textContent = selectedArticles.length;
        
        // Update showing info
        const showingStart = filteredArticleCards.length > 0 ? start + 1 : 0;
        const showingEnd = Math.min(end, filteredArticleCards.length);
        document.getElementById('showingStart').textContent = showingStart;
        document.getElementById('showingEnd').textContent = showingEnd;
        document.getElementById('showingTotal').textContent = filteredArticleCards.length;
    }

    function updatePaginationControls() {
        totalPages = Math.ceil(filteredArticleCards.length / itemsPerPage) || 1;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        
        const firstBtn = document.getElementById('firstPageBtn');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const lastBtn = document.getElementById('lastPageBtn');
        
        // Update button states
        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage === totalPages;
        
        firstBtn.disabled = isFirstPage;
        prevBtn.disabled = isFirstPage;
        nextBtn.disabled = isLastPage;
        lastBtn.disabled = isLastPage;
        
        firstBtn.style.opacity = isFirstPage ? '0.5' : '1';
        prevBtn.style.opacity = isFirstPage ? '0.5' : '1';
        nextBtn.style.opacity = isLastPage ? '0.5' : '1';
        lastBtn.style.opacity = isLastPage ? '0.5' : '1';
        
        firstBtn.style.cursor = isFirstPage ? 'not-allowed' : 'pointer';
        prevBtn.style.cursor = isFirstPage ? 'not-allowed' : 'pointer';
        nextBtn.style.cursor = isLastPage ? 'not-allowed' : 'pointer';
        lastBtn.style.cursor = isLastPage ? 'not-allowed' : 'pointer';
    }

    // Category Filtering (Real-time without page reload)
    function filterByCategory(category) {
        currentCategory = category;
        
        // Update button states
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');

        // Filter articles
        if (category === 'all') {
            filteredArticleCards = [...allArticleCards];
        } else {
            filteredArticleCards = allArticleCards.filter(card => card.dataset.category === category);
        }
        
        // Apply active time filter sorting if any
        applySortingToArticles();
        
        // Reset to page 1
        renderPage(1);
    }

    // Apply time-based sorting to articles
    function applySortingToArticles() {
        if (activeFilters.time.length === 0) return;
        
        const timeRange = activeFilters.time[0];
        
        // Sort by published date
        filteredArticleCards.sort((cardA, cardB) => {
            const dateA = new Date(cardA.dataset.published || cardA.dataset.published);
            const dateB = new Date(cardB.dataset.published || cardB.dataset.published);
            
            if (timeRange === 'latest') {
                // Newest first
                return dateB - dateA;
            } else if (timeRange === 'older') {
                // Oldest first
                return dateA - dateB;
            }
            return 0;
        });
    }

    // Article Selection
    function toggleArticleSelection(card) {
        // Prevent selection if card is hidden by filter
        if (card.style.display === 'none') return;
        
        const articleId = card.dataset.articleId;
        const index = selectedArticles.findIndex(a => a.id === articleId);

        if (index > -1) {
            selectedArticles.splice(index, 1);
            card.classList.remove('selected');
        } else {
            selectedArticles.push({
                id: articleId,
                title: card.dataset.title,
                url: card.dataset.url,
                category: card.dataset.category
            });
            card.classList.add('selected');
        }

        updateCounts();
        updateButtonStates();
    }

    function updateCounts() {
        // Count only visible articles
        const allCards = document.querySelectorAll('.article-card');
        let visibleCount = 0;
        
        allCards.forEach(card => {
            if (card.style.display !== 'none' && !card.querySelector('.fas.fa-inbox')) {
                visibleCount++;
            }
        });
        
        const selectedCount = selectedArticles.length;
        
        document.getElementById('selectedCount').textContent = selectedCount;
        
        // Update Run Automation button display
        const selectedCountDisplay = document.getElementById('selectedCountDisplay');
        if (selectedCountDisplay) {
            if (selectedCount > 0) {
                selectedCountDisplay.textContent = `${selectedCount} article${selectedCount > 1 ? 's' : ''} selected`;
                selectedCountDisplay.style.color = '#059669';
                selectedCountDisplay.style.fontWeight = '600';
            } else {
                selectedCountDisplay.textContent = 'Select articles to run';
                selectedCountDisplay.style.color = '#6b7280';
                selectedCountDisplay.style.fontWeight = '400';
            }
        }
        
        // Only update total if it changed from filtering
        if (visibleCount > 0) {
            document.getElementById('totalCount').textContent = visibleCount;
        }
    }

    function updateButtonStates() {
        const hasArticles = selectedArticles.length > 0;
        const hasProfiles = document.querySelectorAll('.profile-checkbox:checked').length > 0;


    }

    // Clear all selections and reset UI to initial state
    function clearAllSelectionsAndState() {
        console.log('Clearing all selections and resetting state...');
        
        // Clear selectedArticles array
        selectedArticles = [];
        
        // Remove 'selected' class from all article cards
        document.querySelectorAll('.article-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Uncheck all profile checkboxes
        document.querySelectorAll('.profile-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Reset counts and displays
        updateCounts();
        updateButtonStates();
        
        // Clear any stored article data
        delete window.lastArticleData;
        
        // Reset filters to default if needed (but don't clear them aggressively)
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter && categoryFilter.value) {
            categoryFilter.value = '';
        }
        
        const sourceFilter = document.getElementById('sourceFilter');
        if (sourceFilter && sourceFilter.value) {
            sourceFilter.value = '';
        }
        
        const searchFilter = document.getElementById('searchFilter');
        if (searchFilter && searchFilter.value) {
            searchFilter.value = '';
        }
        
        // Add visual feedback that state was cleared (only if progress log exists)
        const progressLog = document.getElementById('progressLog');
        if (progressLog) {
            addLogEntry('🔄 State cleared - Ready for new automation run', 'success');
        }
        
        console.log('State cleared successfully - ready for new automation run');
    }

    // Make the function globally available for manual testing/debugging
    window.clearAllSelectionsAndState = clearAllSelectionsAndState;

    // Update button states when profiles are selected
    document.querySelectorAll('.profile-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateButtonStates);
    });

    // Collect RSS Articles
    async function collectRSS() {
        const btn = document.getElementById('collectBtn');
        btn.disabled = true;
        showProgress();

        try {
            const response = await fetch('{{ url_for("api_sports_collect_rss") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (data.success) {
                addLogEntry(`✅ Collected ${data.total_articles} articles from ${data.successful_sources}/${data.sources_processed} sources`, 'success');
                
                // Store last updated timestamp for persistence
                if (data.last_updated) {
                    storage.setItem('sports_last_article', JSON.stringify({
                        timestamp: data.last_updated
                    }));
                    
                    // Immediately update the display
                    loadLastArticleInfo();
                }
                
                // Show success notification popup with last article info
                showSuccessNotification(
                    'RSS Collection Successful!',
                    `Successfully collected ${data.total_articles} sports articles from ${data.successful_sources}/${data.sources_processed} sources.`,
                    {
                        categories: data.categories,
                        completion_score: data.completion_score,
                        last_article: data.last_article
                    }
                );
                
                // Reload page after 3 seconds to show new articles
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                addLogEntry(`❌ Error: ${data.error}`, 'error');
                alert('Error collecting articles: ' + data.error);
            }
        } catch (error) {
            addLogEntry(`❌ Error: ${error.message}`, 'error');
            alert('Network error: ' + error.message);
        } finally {
            btn.disabled = false;
        }
    }
    
    // Safe localStorage wrapper with fallback
    const storage = {
        setItem: function(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.warn('localStorage not available, using session fallback:', e);
                // Use sessionStorage as fallback
                try {
                    sessionStorage.setItem(key, value);
                    return true;
                } catch (e2) {
                    console.error('Both localStorage and sessionStorage blocked:', e2);
                    // Store in memory as last resort
                    window['_fallback_' + key] = value;
                    return false;
                }
            }
        },
        getItem: function(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                // Try sessionStorage fallback
                try {
                    return sessionStorage.getItem(key);
                } catch (e2) {
                    // Try memory fallback
                    return window['_fallback_' + key] || null;
                }
            }
        }
    };
    
    // Load last article info from storage
    function loadLastArticleInfo() {
        console.log('🔍 loadLastArticleInfo called');
        const lastArticleData = storage.getItem('sports_last_article');
        console.log('📦 Retrieved storage data:', lastArticleData);
        
        if (lastArticleData) {
            try {
                const data = JSON.parse(lastArticleData);
                console.log('✅ Parsed data:', data);
                
                const lastUpdatedInfo = document.getElementById('lastUpdatedInfo');
                const timestampEl = document.getElementById('lastUpdatedTimestamp');
                
                console.log('🎯 DOM elements:', {
                    lastUpdatedInfo: !!lastUpdatedInfo,
                    timestampEl: !!timestampEl
                });
                
                if (lastUpdatedInfo && timestampEl && data.timestamp) {
                    const updateDate = new Date(data.timestamp);
                    timestampEl.textContent = updateDate.toLocaleString();
                    lastUpdatedInfo.style.display = 'block';
                    console.log('⏰ Updated timestamp to:', updateDate.toLocaleString());
                }
            } catch (e) {
                console.error('❌ Failed to load last article data:', e);
            }
        } else {
            console.log('⚠️ No last article data found in storage');
        }
    }

    // Refresh Articles - With full page reload
    async function refreshArticles() {
        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        
        try {
            const response = await fetch('{{ url_for("api_sports_get_articles") }}?category=' + currentCategory);
            const data = await response.json();
            
            if (data.success) {
                // Reload page to show updated articles
                location.reload();
            } else {
                alert('Error refreshing articles: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            btn.disabled = false;
        }
    }

    // Refresh Articles - Without full page reload (used after automation)
    async function refreshArticlesWithoutReload() {
        try {
            const response = await fetch('{{ url_for("api_sports_get_articles") }}?category=' + currentCategory);
            const data = await response.json();
            
            if (data.success) {
                // Update articles display without reloading
                updateArticlesDisplay(data.articles, data.summary);
                addLogEntry('✅ Articles refreshed successfully', 'success');
            }
        } catch (error) {
            console.error('Error refreshing articles:', error);
        }
    }

    // Run Automation - Full Pipeline (Perplexity + Gemini + WordPress)
    async function runAutomation() {
        // Validation
        if (selectedArticles.length === 0) {
            alert('⚠️ Please select at least one article to run automation.');
            return;
        }

        const selectedProfiles = Array.from(document.querySelectorAll('.profile-checkbox:checked')).map(cb => cb.value);
        
        if (selectedProfiles.length === 0) {
            alert('⚠️ Please select at least one WordPress profile to publish to.');
            return;
        }

        // Optional: Check if category IDs are provided (warn but don't block)
        let profilesWithoutCategoryId = [];
        selectedProfiles.forEach(profileId => {
            const categoryInput = document.querySelector(`input[name="category_id_${profileId}"]`);
            if (!categoryInput || !categoryInput.value.trim()) {
                const profileName = document.querySelector(`label[for="profile_${profileId}"]`)?.textContent || profileId;
                profilesWithoutCategoryId.push(profileName);
            }
        });

        // Show warning but allow to continue (since we have fallbacks)
        if (profilesWithoutCategoryId.length > 0) {
            const proceed = confirm(`⚠️ No dynamic category ID specified for:\n${profilesWithoutCategoryId.join(', ')}\n\nThe system will use profile defaults or fallback categories.\n\nContinue with automation?`);
            if (!proceed) return;
        }

        const confirmed = confirm(
            `🚀 Run Full AI Article Generation & Publishing?\n\n` +
            `Articles: ${selectedArticles.length}\n` +
            `Profiles: ${selectedProfiles.length}\n\n` +
            `This will:\n` +
            `1. Research each article using Perplexity AI\n` +
            `2. Generate SEO-optimized content with Gemini AI\n` +
            `3. Publish to selected WordPress sites\n\n` +
            `Continue?`
        );

        if (!confirmed) return;

        const btn = document.getElementById('runAutomationBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Automation...';
        
        showProgress();
        addLogEntry('🚀 Starting AI article generation and publishing pipeline...', 'info');

        try {
            // Debug logging
            console.log('📊 Selected Articles:', selectedArticles);
            console.log('📊 Selected Profiles:', selectedProfiles);
            
            // Prepare form data
            const formData = new FormData();
            
            // Add selected article IDs
            const articlesJson = JSON.stringify(selectedArticles);
            console.log('📦 Articles JSON:', articlesJson);
            formData.append('selected_articles', articlesJson);
            
            // Add selected profile IDs
            selectedProfiles.forEach(profileId => {
                formData.append('run_profile_ids[]', profileId);
            });

            // Get publish status and category for each profile
            selectedProfiles.forEach(profileId => {
                const statusSelect = document.querySelector(`select[name="publish_status_${profileId}"]`);
                const categoryInput = document.querySelector(`input[name="category_id_${profileId}"]`);
                
                // Debug logging
                console.log(`Profile ${profileId}:`, {
                    statusSelect: statusSelect ? statusSelect.value : 'NOT FOUND',
                    categoryInput: categoryInput ? categoryInput.value : 'NOT FOUND',
                    categoryElement: categoryInput ? 'EXISTS' : 'MISSING'
                });
                
                if (statusSelect) {
                    formData.append(`publish_status_${profileId}`, statusSelect.value);
                    console.log(`Added publish_status_${profileId}: ${statusSelect.value}`);
                }
                
                // Always append category ID (validation already ensured it has a value)
                if (categoryInput) {
                    formData.append(`category_id_${profileId}`, categoryInput.value);
                    console.log(`Added category_id_${profileId}: ${categoryInput.value}`);
                } else {
                    console.error(`ERROR: Category input not found for profile ${profileId}`);
                }
            });

            addLogEntry(`📊 Processing ${selectedArticles.length} article(s) for ${selectedProfiles.length} profile(s)...`, 'info');

            // Submit to backend
            const response = await fetch('/run-sports-automation', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.text();
            
            // The backend uses flash messages and redirects
            // SocketIO will handle real-time progress updates
            addLogEntry('✅ Automation pipeline started! Watch the logs for progress...', 'success');
            
            // Listen for SocketIO updates
            socket.on('sports_automation_update', function(data) {
                const level = data.level || 'info';
                addLogEntry(data.message, level);
                
                if (data.stage === 'complete') {
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
            });

        } catch (error) {
            console.error('Automation error:', error);
            addLogEntry(`❌ Error: ${error.message}`, 'error');
            alert('Failed to start automation: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<div style="display: flex; align-items: center; gap: 1rem;"><div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i class="fas fa-magic" style="font-size: 1.5rem; color: white;"></i></div><div style="flex: 1;"><div style="font-weight: 600; font-size: 1rem; color: hsl(var(--foreground)); margin-bottom: 0.25rem;">Run Automation</div><small style="color: hsl(var(--muted-foreground)); font-size: 0.85rem; line-height: 1.4; display: block;">Generate AI articles and publish to WordPress sites</small></div></div>';
        }
    }





    // Advanced Filters Functions - Improved
    let activeFilters = {
        importance: [],
        time: [],
        source: [],
        score: 0,
        limit: 50,
        sort: 'score_desc'
    };

    function toggleFiltersDropdown() {
        const panel = document.getElementById('filterDropdownPanel');
        const btn = document.getElementById('filterDropdownBtn');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            btn.classList.add('active');
            updateActiveFiltersSummary();
        } else {
            panel.style.display = 'none';
            btn.classList.remove('active');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const panel = document.getElementById('filterDropdownPanel');
        const btn = document.getElementById('filterDropdownBtn');
        
        if (panel && panel.style.display === 'block' && !panel.contains(event.target) && !btn.contains(event.target)) {
            panel.style.display = 'none';
            btn.classList.remove('active');
        }
    });

    // Sync score slider and input with real-time filtering
    function syncScoreInput(value) {
        activeFilters.score = parseFloat(value);
        document.getElementById('filterScoreDisplay').textContent = value;
        document.getElementById('filterScoreValue').textContent = value;
        
        // Apply score filter immediately
        applyScoreFilterToArticles();
    }

    // Apply score filter to articles in real-time
    function applyScoreFilterToArticles() {
        if (activeFilters.score === 0) {
            // No score filter, show all
            filteredArticleCards = [...allArticleCards];
        } else {
            // Filter by score
            filteredArticleCards = allArticleCards.filter(card => {
                const cardScore = parseFloat(card.dataset.score || 0);
                return cardScore >= activeFilters.score;
            });
        }
        
        // Re-apply time sorting if active
        applySortingToArticles();
        
        // Re-render
        renderPage(1);
    }

    // Toggle importance filter
    function toggleImportanceFilter(importance) {
        const btn = document.querySelector(`[data-importance="${importance}"]`);
        const index = activeFilters.importance.indexOf(importance);
        
        if (index > -1) {
            activeFilters.importance.splice(index, 1);
            btn.classList.remove('active');
        } else {
            activeFilters.importance.push(importance);
            btn.classList.add('active');
        }
        updateActiveFiltersSummary();
    }

    // Toggle time filter - Sorts by latest/oldest dates
    function toggleTimeFilter(timeRange) {
        const btn = document.querySelector(`[data-time="${timeRange}"]`);
        
        // Clear other time filters when selecting a new one (single select)
        document.querySelectorAll('[data-time]').forEach(b => {
            if (b !== btn) {
                b.classList.remove('active');
            }
        });
        
        const index = activeFilters.time.indexOf(timeRange);
        
        if (index > -1) {
            activeFilters.time.splice(index, 1);
            btn.classList.remove('active');
            // Reset sort when deselecting
            activeFilters.sort = 'score_desc';
        } else {
            activeFilters.time = [timeRange];
            btn.classList.add('active');
            
            // Set sort based on time range selected
            if (timeRange === 'latest') {
                activeFilters.sort = 'newest';
            } else if (timeRange === 'older') {
                activeFilters.sort = 'oldest';
            }
        }
        
        updateActiveFiltersSummary();
        
        // Apply sorting immediately to displayed articles
        applySortingToArticles();
        renderPage(1);
    }

    // Toggle source filter
    function toggleSourceFilter(source) {
        const btn = document.querySelector(`[data-source="${source}"]`);
        const index = activeFilters.source.indexOf(source);
        
        if (index > -1) {
            activeFilters.source.splice(index, 1);
            btn.classList.remove('active');
        } else {
            activeFilters.source.push(source);
            btn.classList.add('active');
        }
        updateActiveFiltersSummary();
    }

    // Update active filters summary display
    function updateActiveFiltersSummary() {
        const summary = [];
        const counts = {
            importance: activeFilters.importance.length,
            time: activeFilters.time.length,
            source: activeFilters.source.length
        };

        if (activeFilters.score > 0) summary.push(`Score ≥ ${activeFilters.score}`);
        if (counts.importance > 0) summary.push(`${counts.importance} Importance Level(s)`);
        if (counts.time > 0) summary.push(`${counts.time} Time Range(s)`);
        if (counts.source > 0) summary.push(`${counts.source} Source(s)`);

        const summaryEl = document.getElementById('activeFiltersSummary');
        const summaryText = document.getElementById('activeFiltersText');

        if (summary.length > 0) {
            summaryText.textContent = `Filters: ${summary.join(' • ')}`;
            summaryEl.style.display = 'block';
        } else {
            summaryEl.style.display = 'none';
        }
    }

    async function applyAdvancedFilters() {
        showProgress();
        addLogEntry('🔍 Applying smart filters...', 'info');
        
        // Build filter parameters
        const params = new URLSearchParams();
        params.append('category', currentCategory);
        
        // Importance levels
        if (activeFilters.importance.length > 0) {
            activeFilters.importance.forEach(tier => params.append('importance_tiers[]', tier));
            addLogEntry(`📌 Filter: Importance levels: ${activeFilters.importance.join(', ')}`, 'info');
        }
        
        // Score
        if (activeFilters.score > 0) {
            params.append('min_score', activeFilters.score);
            addLogEntry(`⭐ Filter: Minimum score: ${activeFilters.score}`, 'info');
        }
        
        // Time ranges
        if (activeFilters.time.length > 0) {
            const timeRange = activeFilters.time[0];
            if (timeRange === 'last_6h') {
                params.append('max_age_hours', 6);
                addLogEntry(`🕐 Filter: Last 6 hours only`, 'info');
            } else if (timeRange === 'last_24h') {
                params.append('max_age_hours', 24);
                addLogEntry(`🕐 Filter: Last 24 hours only`, 'info');
            } else if (timeRange === 'latest') {
                params.append('sort_by_date', 'newest');
                addLogEntry(`🕐 Filter: Showing Latest Articles First`, 'info');
            } else if (timeRange === 'older') {
                params.append('sort_by_date', 'oldest');
                addLogEntry(`🕐 Filter: Showing Older Articles First`, 'info');
            }
        }
        
        // Source quality
        if (activeFilters.source.length > 0) {
            activeFilters.source.forEach(src => params.append('source_authority[]', src));
            addLogEntry(`🛡️ Filter: Source quality: ${activeFilters.source.join(', ')}`, 'info');
        }
        
        // Limit and sort
        params.append('limit', activeFilters.limit);
        params.append('sort', activeFilters.sort);
        
        try {
            const response = await fetch(`{{ url_for("api_sports_get_articles") }}?${params.toString()}`);
            const data = await response.json();
            
            if (data.success) {
                addLogEntry(`✅ Found ${data.count} articles matching filters`, 'success');
                if (data.summary && data.summary.by_category) {
                    addLogEntry(`📊 Breakdown: ${JSON.stringify(data.summary.by_category)}`, 'info');
                }
                updateArticlesDisplay(data.articles, data.summary);
            } else {
                addLogEntry(`❌ Error: ${data.error}`, 'error');
                alert('Filter error: ' + data.error);
            }
        } catch (error) {
            addLogEntry(`❌ Error: ${error.message}`, 'error');
            alert('Network error: ' + error.message);
        }
    }

    function resetFilters() {
        // Reset all filter states
        activeFilters = {
            importance: [],
            time: [],
            source: [],
            score: 0,
            limit: 50,
            sort: 'score_desc'
        };

        // Clear UI
        document.getElementById('filterMinScoreRange').value = '0';
        document.getElementById('filterScoreDisplay').textContent = '0';
        document.getElementById('filterScoreValue').textContent = '0';
        document.getElementById('filterLimit').value = '50';
        document.getElementById('filterSort').value = 'score_desc';

        // Remove active class from all filter buttons
        document.querySelectorAll('.filter-tag-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        updateActiveFiltersSummary();
        filteredArticleCards = [...allArticleCards];
        applySortingToArticles();
        renderPage(1);
    }

    function updateArticlesDisplay(articles, summary) {
        const grid = document.getElementById('articlesGrid');
        const currentView = grid.dataset.currentView || 'card';
        
        if (articles.length === 0) {
            allArticleCards = [];
            filteredArticleCards = [];
            renderPage(1);
            hideProgress();
            return;
        }
        
        // Create new card elements
        const newCards = articles.map(article => {
            const card = document.createElement('div');
            card.className = 'article-card';
            card.dataset.articleId = article.id || article.title;
            card.dataset.category = article.category || 'uncategorized';
            card.dataset.importance = article.importance_tier || 'Medium';
            card.dataset.score = article.importance_score || 50;
            card.dataset.published = article.published_date || '';
            card.dataset.title = article.title;
            card.dataset.url = article.link || article.url || '';
            
            const scoringBreakdown = article.scoring_breakdown ? `
                <div class="scoring-breakdown">
                    <h4><i class="fas fa-calculator"></i> Scoring Breakdown</h4>
                    <div class="scoring-grid">
                        <div class="score-item">
                            <span class="score-label">Content Score:</span>
                            <span class="score-value">${(article.scoring_breakdown.content_score || 0).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Source Authority:</span>
                            <span class="score-value">${(article.scoring_breakdown.source_authority || 0).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Temporal Factor:</span>
                            <span class="score-value">${(article.scoring_breakdown.temporal_factor || 0).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Engagement Predictor:</span>
                            <span class="score-value">${(article.scoring_breakdown.engagement_predictor || 0).toFixed(1)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Category Multiplier:</span>
                            <span class="score-value">${(article.scoring_breakdown.category_multiplier || 1).toFixed(2)}</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Trending Boost:</span>
                            <span class="score-value">${(article.scoring_breakdown.trending_boost || 0).toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            ` : '';
            
            card.innerHTML = `
                <div class="select-indicator" onclick="event.stopPropagation(); toggleArticleSelection(this.parentElement)">
                    <i class="fas fa-check"></i>
                </div>
                
                <div class="article-dropdown-header" style="${currentView === 'dropdown' ? 'display: flex;' : 'display: none;'}" onclick="event.stopPropagation(); toggleDropdown(this.parentElement)">
                    <div class="article-dropdown-header-content">
                        <div class="select-indicator" onclick="event.stopPropagation(); toggleArticleSelection(this.closest('.article-card'))">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <h4 class="article-title" style="margin: 0;">${article.title}</h4>
                            <div class="article-meta" style="margin-top: 0.25rem;">
                                <span class="article-meta-item">
                                    <i class="fas fa-tag"></i> ${article.category || 'Uncategorized'}
                                </span>
                                <span class="article-meta-item">
                                    <i class="fas fa-star"></i> ${article.importance_tier || 'Medium'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="article-dropdown-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                
                <div class="article-content" style="${currentView === 'dropdown' ? 'display: none;' : 'display: block;'}" onclick="toggleArticleSelection(this.parentElement)">
                    <h4 class="article-title">${article.title}</h4>
                    
                    <p class="article-summary">${(article.summary || 'No summary available').substring(0, 200)}${(article.summary || '').length > 200 ? '...' : ''}</p>
                    
                    <div class="article-meta">
                        <span class="article-meta-item">
                            <i class="fas fa-clock"></i>
                            ${article.published_date || 'Unknown Date'}
                        </span>
                        <span class="article-meta-item">
                            <i class="fas fa-user"></i>
                            ${article.author || 'Unknown Author'}
                        </span>
                    </div>
                    
                    <div class="article-badges">
                        <span class="badge badge-category">
                            <i class="fas fa-tag"></i> ${article.category || 'Uncategorized'}
                        </span>
                        <span class="badge badge-${(article.importance_tier || 'medium').toLowerCase()}">
                            <i class="fas fa-star"></i> ${article.importance_tier || 'Medium'}
                        </span>
                        <span class="badge badge-score">
                            <i class="fas fa-chart-line"></i> ${(article.importance_score || 50).toFixed(1)}
                        </span>
                        <span class="badge badge-source">
                            <i class="fas fa-clock"></i> ${(article.time_bracket || 'recent').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
                        </span>
                    </div>
                </div>
                
                <div class="article-dropdown-body">
                    <div class="article-dropdown-content">
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <span class="metadata-label">Article ID</span>
                                <span class="metadata-value">${article.id || 'N/A'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Importance Score</span>
                                <span class="metadata-value">${(article.importance_score || 0).toFixed(2)}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Hybrid Rank</span>
                                <span class="metadata-value">#${article.hybrid_rank || 'N/A'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Time Bracket</span>
                                <span class="metadata-value">${(article.time_bracket || 'recent').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Collected Date</span>
                                <span class="metadata-value">${article.collected_date || 'Unknown'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Source URL</span>
                                <span class="metadata-value">
                                    <a href="${article.link || article.url || '#'}" target="_blank" style="color: var(--blue-600); text-decoration: none;">
                                        <i class="fas fa-external-link-alt"></i> View Source
                                    </a>
                                </span>
                            </div>
                        </div>
                        
                        ${scoringBreakdown}
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid hsl(var(--border));">
                            <p style="font-size: 0.875rem; line-height: 1.6; color: hsl(var(--foreground));">${article.summary || 'No summary available'}</p>
                        </div>
                    </div>
                </div>
            `;
            return card;
        });
        
        allArticleCards = newCards;
        
        // Re-apply current category filter
        if (currentCategory === 'all') {
            filteredArticleCards = [...allArticleCards];
        } else {
            filteredArticleCards = allArticleCards.filter(card => card.dataset.category === currentCategory);
        }
        
        // Re-apply score filter if active
        applyScoreFilterToArticles();
        
        renderPage(1);
        hideProgress();
    }

    // Initialize counts on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOMContentLoaded event fired');
        initPagination();
        updateCounts();
        loadLastArticleInfo(); // Load last article info from localStorage
    });
    
    // Also load immediately in case DOMContentLoaded already fired
    if (document.readyState === 'loading') {
        console.log('⏳ Document still loading, waiting for DOMContentLoaded');
        // Still loading, wait for DOMContentLoaded
    } else {
        // DOM is already ready
        console.log('✅ DOM already ready, loading last article info immediately');
        loadLastArticleInfo();
    }
    
    // Manual test function - can be called from browser console
    window.testLastArticleInfo = function() {
        console.log('🧪 Testing last article info display...');
        
        // Create test data
        const testData = {
            title: 'Test Article Title - Manual Test',
            source: 'Test Source',
            timestamp: new Date().toISOString()
        };
        
        console.log('📝 Setting test data:', testData);
        storage.setItem('sports_last_article', JSON.stringify(testData));
        
        console.log('🔄 Calling loadLastArticleInfo...');
        loadLastArticleInfo();
        
        console.log('✅ Test complete! Check the Collect RSS card.');
    };
</script>
{% endblock %}
